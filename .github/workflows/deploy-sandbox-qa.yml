name: deploy
on:
  push:
    branches: ['sandbox', 'qa']
env:
  APP_NAME: 'demo-fastapi'
  AWS_ACCESS_KEY_ID: ${{ secrets.DEPLOYER_AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.DEPLOYER_AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: ap-northeast-2
  DOCKER_BUILDKIT: 1
jobs:
  deploy-sandbox-qa:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-${{ github.ref_name }}
      cancel-in-progress: false
    steps:
      - name: checkout
        uses: actions/checkout@main
        with:
          fetch-depth: 2

      - name: setup node.js 24
        uses: actions/setup-node@main
        with:
          node-version: 24

      - name: Cache npm
        uses: actions/cache@main
        with:
          path: ~/.npm/_npx
          key: ${{ runner.os }}-npx-serverless-v3

      - name: install serverless
        run: npm i -g serverless@3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@main
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@main

      - name: Ensure ECR repository exists
        run: |
          REPO_NAME="lambda-${{ env.APP_NAME }}-${{ github.ref_name }}"
          if aws ecr describe-repositories --repository-names "$REPO_NAME" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "‚úÖ ECR repository already exists: $REPO_NAME"
          else
            echo "üì¶ Creating ECR repository: $REPO_NAME"
            aws ecr create-repository \
              --repository-name "$REPO_NAME" \
              --region ${{ env.AWS_REGION }} \
              --image-scanning-configuration scanOnPush=true \
              --tags Key=Environment,Value=${{ github.ref_name }} Key=Application,Value=${{ env.APP_NAME }}
            echo "‚úÖ ECR repository created with image scanning enabled"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@master

      - name: Set ECR repository info
        id: ecr-repo
        run: |
          REPO_NAME="lambda-${{ env.APP_NAME }}-${{ github.ref_name }}"
          REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          echo "uri=$REGISTRY/$REPO_NAME" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@master
        with:
          context: .
          push: true
          tags: ${{ steps.ecr-repo.outputs.uri }}:latest
          platforms: linux/amd64
          cache-from: type=registry,ref=${{ steps.ecr-repo.outputs.uri }}:cache
          cache-to: type=registry,ref=${{ steps.ecr-repo.outputs.uri }}:cache,mode=max
          provenance: false

      - name: Check infrastructure changes
        id: infra-check
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -qE '^(serverless\.yml|serverless-env/)'; then
            echo "full_deploy=true" >> $GITHUB_OUTPUT
            echo "üì¶ Infrastructure changes detected - full deploy"
          else
            echo "full_deploy=false" >> $GITHUB_OUTPUT
            echo "‚ö° Code only changes - function deploy"
          fi

      - name: deploy-${{ github.ref_name }}
        run: |
          IMAGE_URI="${{ steps.ecr-repo.outputs.uri }}:${{ github.ref_name }}"
          FUNCTION_NAME="${{ env.APP_NAME }}-${{ github.ref_name }}"

          if [ "${{ steps.infra-check.outputs.full_deploy }}" = "true" ]; then
            echo "üì¶ Full deploy with Serverless"
            SLS_ECR_IMAGE_URI="$IMAGE_URI" SLS_FUNCTION_NAME="$FUNCTION_NAME" npx serverless@3 deploy -s ${{ github.ref_name }}
          else
            echo "‚ö° Quick deploy with AWS CLI"
            if aws lambda update-function-code \
              --function-name "$FUNCTION_NAME" \
              --image-uri "$IMAGE_URI" \
              --no-cli-pager 2>&1; then
              echo "‚úÖ Lambda updated"
            else
              echo "‚ö†Ô∏è Quick deploy failed (function may not exist), falling back to full deploy"
              echo "üì¶ Full deploy with Serverless"
              SLS_ECR_IMAGE_URI="$IMAGE_URI" SLS_FUNCTION_NAME="$FUNCTION_NAME" npx serverless@3 deploy -s ${{ github.ref_name }}
            fi
          
            echo "‚è≥ Waiting for function update..."
            aws lambda wait function-updated --function-name "$FUNCTION_NAME"
            echo "‚úÖ Lambda function updated successfully"
          fi
